<!DOCTYPE html>
<html lang="en">
<head>
    <link rel="icon" href="../img/P.png">
    <meta charset="UTF-8">
    <meta name="google" content="notranslate">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GENHOSPI</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/awesomplete/1.1.5/awesomplete.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/awesomplete/1.1.5/awesomplete.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.all.min.js"></script>
    <link rel="stylesheet" href="index.css">
</head>
<body>
    <div class="user" id="username">
    </div>
    <div class="div-btn-back">
        <button class="btn-back btn-dark consu" onclick="goBack()">
            <i class="fa-solid fa-house"></i>   
        </buttton>
    </div>
    <div class="container mt-3">
                <div class="div_botones d-flex justify-content-between">
                    <div class="btn-group">
                        <button id="facturacion-btn" class="btn-success btn-custom-1">Facturacion Pendiente</button>
                        <button id="agregar-paciente-btn-1" class="btn-success btn-custom-1">Agregar Paciente</button>
                        <button id="usuarios-btn"class="btn-success btn-custom-1">Gestion Usuarios</button>
                        <button id="consulta-btn"class="btn-success btn-custom-1">Consulta Pendientes</button>
                    </div>
                    <!-- Botón para generar reporte -->
                    <!-- <button id="generar-reporte" class="btn-success btn-custom-1 last-btn" onclick="mostrarOpciones()">Generar Reporte</button> -->
                    <div class="btn-group">
                        <button id="generar-reporte" class="btn-success btn-custom-1 last-btn" onclick="mostrarOpciones()">Generar Reporte</button>
                        <button id="logoutButton" class="log-btn btn-danger">
                            <i class="fa-solid fa-right-from-bracket"></i>
                        </button>
                    </div>
                </div><br>
        <h1 class="text-center text-dark mb-6 consu" id="texto_principal">Datos Afiliado</h1>
        <div class="formulario_principal" id="id_formulario_principal">
            <div class="row">
                <div class="col-md-12">
                    <table class="w-100">
                        <thead class="text-dark">
                            <tr>
                                <th class="text-center">Fecha Solicitud</th>
                                <th class="text-center">Identificación</th>
                                <th class="text-center">Tipo ID</th>
                                <th class="text-center">Paciente</th>
                                <th class="text-center">Celular</th>
                                <th class="text-center">EPS</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td><input type="date" id="fecha_solicitud" class="form-control" onkeydown="return false;"></td>
                                <td><input type="text" class="form-control identificacion" required></td>
                                <td><input type="text" id ="tipoIdentificacion" class="form-control form-id" readonly></td>
                                <td><input type="text" id="nombrePaciente" class="form-control form-paciente" readonly></td>
                                <td><input type="text" id="celular1" class="form-control form-telefono"></td>
                                <td><input type="text" id="eps" maxlength="50" class="form-control form-eps" readonly></td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="row">
                <div class="col-md-12">
                    <table class="w-100">
                        <thead class="text-dark">
                            <tr>
                                <th class="text-center">Nº Fórmula</th>
                                <th class="text-center">Celular 2</th>
                                <th class="text-center">Dirección</th>
                                <th class="text-center">Ámbito de prestación de la actividad</th>
                                <th class="text-center">NIT IPS Formula</th>
                                <th class="text-center">Nombre IPS que formula</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td><input type="number" id="numeroFormula" maxlength="50" class="form-control"></td>
                                <td><input type="number" id="celular2" maxlength="10" class="form-control"></td>
                                <td><input type="text" id="direccion" class="form-control"></td>
                                <td><input type="text" id="ambito" class="form-control" value="Ambulatorio"></td>
                                <td><input type="number" id="NITIPS" class="form-control"></td>
                                <td><input type="text" id="nombreIPS" class="form-control"></td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        
            <div class="row">
                <div class="col-md-12">
                    <table class="mt-2 w-100">
                        <thead class="text-dark">
                            <tr>
                                <th class="text-center">Modalidad</th>
                                <th class="text-center">Código Diagnóstico</th>
                                <th class="text-center w-50">Diagnóstico</th>
                                <th class="text-left" style="width: 85px;">Plan</th>
                                <th class="text-center">Fecha Fórmula</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>
                                    <select class="form-control" id="modalidad">
                                        <option value="" selected disabled>Seleccione una opción</option>
                                        <option value="CAPITA">CAPITA</option>
                                        <option value="EVENTO">EVENTO</option>
                                        <option value="PGP">PGP</option>
                                        <option value="MIPRES">MIPRES</option>
                                    </select>
                                </td>
                                <td><input type="text" id="codigoDiagnostico" class="form-control diagnostico" maxlength="4"></td>
                                <td><input type="text" id="nombreDiagnostico" class="form-control form-nombre-diagnostico"></td>
                                <td>
                                    <select id="planSOS" name="plan" class="form-control form-inline-input" required>
                                        <option value="" selected disabled>Seleccione una opción</option>
                                        <option value="CONTRIBUTIVO">CONTRIBUTIVO</option>
                                        <option value="SUBSIDIADO">SUBSIDIADO</option>
                                        <option value="TUTELA">TUTELA</option>
                                    </select>
                                </td>
                                <td><input type="date" class="form-control" id="fechaFormula" onkeydown="return false;"
                                    min="2024-01-01"></td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="row"> 
                <div class="col-md-12">
                    <table class="mt-2 w-100">
                        <thead class="text-dark">
                            <tr>
                                <th class="text-center">Producto</th>
                                <th class="text-center">Laboratorio</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>
                                    <input class="form-control form-prod awesomplete" type="text" id="medicamento" placeholder="Escribe un medicamento..." autocomplete="off" style="display: block;"/>
                                </td>
                                <td><input type="text" id="laboratorio" class="form-control" readonly></td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="row">
                <div class="col-md-12">
                    <table class="mt-2 w-100">
                        <thead class="text-dark">
                            <tr>
                                <th class="text-center">Tipo Producto</th>
                                <th class="text-center">Cobertura</th>
                                <th class="text-center">Cantidad Prescrita</th>
                                <th class="text-center">Tipo de Entrega</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td><input type="text" id="tipo_producto" class="form-control form-tipo"></td>
                                <td><input type="text" id="cobertura" class="form-control form-inline-input"></td>
                                <td><input type="number" id="cantidad_prescrita" maxlength="4" class="form-control" oninput='validarPrescritoDispensado()'></td>
                                <td>
                                    <select name="tipoEntrega" id="tipoEntrega" class="form-control">
                                        <option value="Presencial">Presencial</option>
                                        <option value="Domicilio">Domicilio</option>
                                    </select>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="row">
                <div class="col-md-12">
                    <table class="mt-2 w-100">
                        <thead class="text-dark">
                            <tr>
                                <th class="text-center">Sede del Pendiente</th>
                                <th class="text-center">Estado Dispensacion</th>
                                <th class="text-center">Cum</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>
                                    <input id="sede_pendiente" name="sede_pendiente" type="text" class="form-control form-inline-input" readonly>
                                </td>
                                <td>
                                    <select id="estado-dis" name="estado-dis" class="form-control form-inline-input" required>
                                        <option value="Pendiente">Pendiente</option>
                                        <option value="Programado">Programado</option>
                                    </select>
                                </td>
                                <td><input type="text" id="cum" maxlength="12" class="form-control"></td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="row">
                <div class="col-md-12">
                    <table class="mt-2 w-100">
                        <thead class="text-dark">
                            <tr>
                                <th class="text-center w-50">Observación</th>
                                <th class="text-center w-auto">Control Mensual</th>
                                <th class="text-center w-auto">Cantidad Pendiente</th>
                            </tr>
                            <tr>
                                <th><input type="text" id="observacion" class="form-control"></th>
                                <th>
                                    <select name="control"  id="controlMensual" class="form-control">
                                        <option value="" selected disabled>Seleccione una opción</option>
                                        <option value="SI">SI</option>
                                        <option value="NO">NO</option>
                                    </select>
                                </th>
                                <th><input type="number" id="cantidad_pendiente" class="form-control w-100 ml-1" required oninput='validarPrescritoDispensado()'>
                                <th class="d-flex">
                                    
                                    <button type="submit" id="btn_cantidad_pendiente" class="btn btn-custom btn-block ml-2 w-100">Añadir</button>
                                </th>
                            </tr>
                        </thead>
                    </table>
                </div>
            </div>
            <div class="row mt-2">
                <div class="col-md-12">
                    <table class="table table-bordered">
                        <thead class="bg-success text-white text-center">
                            <tr>
                                <th class="w-75">Producto</th>
                                <th>Laboratorio</th>
                                <th class="bg-danger">Cantidad Pendiente</th>
                            </tr>
                        </thead>
                        <tbody id="tabla-productos">
                            <div id="tabla_resultado">
                            </div>
                        </tbody>
                    </table>
                </div>
            </div>
            <div style="width: 100%;" class="d-flex justify-content-center align-items-center">
                <button id="guardar-btn" class="btn btn-dark" style="box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);">Guardar</button>
            </div> 
        </div>
    </div>
    <!-- Modal de éxito -->
    <div id="successModal" style="display:none;">
        <div style="background: white; padding: 20px; border-radius: 5px; width: 300px; margin: auto; position: relative; box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2); display: flex; align-items: center; flex-direction: column;">
            <p id="modalMessage" style="text-align: center;">Datos guardados correctamente.</p>
            <button id="closeModal" style="background: #0ac150; color: white; border: none; padding: 10px; border-radius: 5px; cursor: pointer;">Aceptar</button>
        </div>
    </div>

    <div id="agregar_usuario" class="container mt-3" style="display: none;">
        <div class="formulario_principal">
            <div class="row">
                <div class="col-md-12">
                    <table class="w-100">
                        <thead class="text-dark">
                            <tr>
                                <th class="text-center">Identificación</th>
                                <th class="text-center">Tipo ID</th>
                                <th class="text-center">Paciente</th>
                                <th class="text-center">Celular</th>
                                <th class="text-center">EPS</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td><input type="text" class="form-control" id="Aidentificacion" required></td>
                                <td>
                                    <select id="AtipoIdentificacion" name="tipoIdentificacion" class="form-control form-inline-input" required>
                                        <option value="" selected disabled>Seleccione una opción</option>
                                        <option value="CC">CC</option>
                                        <option value="TI">TI</option>
                                        <option value="AS">AS</option>
                                        <option value="CE">CE</option>
                                        <option value="CN">CN</option>
                                        <option value="MS">MS</option>
                                        <option value="NI">NI</option>
                                        <option value="PA">PA</option>
                                        <option value="PE">PE</option>
                                        <option value="PT">PT</option>
                                        <option value="RC">RC</option>
                                        <option value="SC">SC</option>
                                        
                                    </select>
                                </td>
                                <td><input type="text" id="AnombrePaciente" class="form-control form-paciente" required oninput="this.value = this.value.replace(/[^a-zA-ZáéíóúÁÉÍÓÚñÑ\s]/g, '');"></td>
                                    <td><input type="number" id="Acelular1" class="form-control form-telefono" required></td>
                                    <td>
                                        <select id="Aeps" name="plan" class="form-control form-eps form-inline-input" required>
                                            <option value="" selected disabled>Seleccione una opción</option>
                                            <option value="EMSSANAR EPS SAS">EMSSANAR EPS SAS</option>
                                            <option value="MALLAMAS EPS">MALLAMAS EPS</option>
                                            <option value="SANITAS EPS">SANITAS EPS</option>
                                            <option value="ASMET SALUD EPS">ASMET SALUD EPS</option>
                                            <option value="SOS SALUD">SOS SALUD</option>
                                        </select>
                                    </td>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="text-center mt-3">
                <button id="agregar-paciente-btn" class="btn btn-custom">Agregar Paciente</button>
            </div>
        </div>
    </div>
    <h2 id="text_agregar_usuario_SU" class="text-center text-dark mb-6 consu" style="display: none;">Agregar Usuario</h2>
    <div id="agregar_usuario_SU" class="container mt-3" style="display: none;">
        <div class="formulario_principal">
            <div class="row">
                <div class="col-md-12">
                    <table class="w-100">
                        <thead class="text-dark">
                            <tr>
                                <th class="text-center">Identificación</th>
                                <th class="text-center">Nombre</th>
                                <th class="text-center">Username</th>
                                <th class="text-center">Password</th>
                                <th class="text-center">sede</th>
                                <th class="text-center">Rol</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td><input type="text" class="form-control" id="AU_identificacion" required></td>
                                <td><input type="text" class="form-control" id="AU_nombre" required></td>
                                <td><input type="text" class="form-control" id="AU_username" required></td>
                                <td><input type="text" class="form-control" id="AU_password" required></td>
                                <td>
                                    <input class="form-control" type="text" id="AU_sede" placeholder="Escribe una sede..." list="sedes_lista" autocomplete="off">
                                    <ul id="sedes_lista" class="sede-list"></ul>
                                </td>
                                <td>
                                    <select id="AU_rol" class="form-control form-eps form-inline-input" required>
                                        <option value="" selected disabled>Seleccione una opción</option>
                                        <option value="user">Usuario</option>
                                        <option value="admin">Administrador</option>
                                    </select>
                                </td>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="text-center mt-3">
                <button id="agregar-usuario-btn" class="btn btn-custom">Agregar Usuario</button>
            </div>
        </div>
    </div>
    <h2 id="text_agregar_medicamento_SU" class="text-center text-dark mb-6 consu" style="display:none; text-shadow: 0 4px 8px rgba(0, 0, 0, 0.4);font-size: 39px;">
        Agregar Medicamento</h2>
    <div id="agregar_medicamento_SU" class="container mt-3" style="display: none;">
        <div class="formulario_principal">
            <div class="row">
                <div class="col-md-12">
                    <table class="w-100">
                        <thead class="text-dark">
                            <tr>
                               
                                <th class="text-center">Nombre</th>
                                <th class="text-center">Laboratorio</th>
                                <th class="text-center">Tipo producto</th>
                                <th class="text-center">Cobertura</th>
                                <th class="text-center">Cum</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                              
                                <td><input type="text" class="form-control" id="AM_nombre" required></td>
                                <td><input type="text" class="form-control" id="AM_laboratorio" required></td>
                                <td>
                                    <select id="AM_tipo_producto" class="form-control form-inline-input" required>
                                        <option value="" selected disabled>Seleccione una opción</option>
                                        <option value="ALIMENTOS">Alimentos</option>
                                        <option value="MEDICAMENTO">Medicamento</option>
                                        <option value="ASEO Y LIMPIEZA">Aseo y limpieza</option>
                                        <option value="COSMETICO">Cosmetico</option>
                                        <option value="DISPOSITIVO MEDICO">Dispositivo medico</option>
                                        <option value="INSUMO">Insumo</option>
                                    </select>
                                </td>
                                <td><input type="text" id="AM_cobertura" class="form-control" required value="PBS"></td>
                                <td><input type="text" id="AM_cum" class="form-control form-telefono" required></td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="text-center mt-3">
                <button id="agregar-medicamento-btn" class="btn btn-custom" style="width: 12rem;">Agregar Medicamento</button>
            </div>
        </div>
    </div>
    
    
    <h2 id="text_actualizar_usuario_SU" class="text-center text-dark mb-6 consu" style="display:none; text-shadow: 2px 2px 0px #c49b2c, 
    4px 4px 0px rgba(0, 0, 0, 0.2); ;font-size: 39px;">Actualizar Usuario</h2>
    <div id="actualizar_usuario_SU" class="container mt-3" style="display: none;">
        <div class="formulario_principal">
            <div class="row">
                <div class="col-md-12">
                    <table class="w-100">
                        <thead class="text-dark">
                            <tr>
                                <th class="text-center">Identificación</th>
                                <th class="text-center">Username</th>
                                <th class="text-center">Sede</th>
                                <th class="text-center">Nueva Sede</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>
                                    <input type="text" class="form-control" id="AU_identificacion_buscar" placeholder="Escribe una identificación" required>
                                </td>
                                <td>
                                    <input type="text" class="form-control" id="AU_username1" readonly>
                                </td>
                                <td>
                                    <input type="text" class="form-control" id="AU_sede1" readonly>
                                </td>
                                <td>
                                    <input class="form-control" type="text" id="AU_sede2" placeholder="Escribe una nueva sede..." list="sedes_lista1" autocomplete="off">
                                    <ul id="sedes_lista1" class="sede-list"></ul>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="text-center mt-3">
                <button id="actualizar-usuario-btn" class="btn btn-custom">Actualizar Sede</button>
            </div>
        </div>
    </div>

    <div id="consulta_usuario" class="container">
        <form id="form_consultar" class="mb-3 d-flex mb-3 justify-content-center align-items-center consu">
            <input type="text" id="identificacion_c" name="identificacion" class="form-control w-25" placeholder="Ingrese la identificación">
            <button type="submit" id="btn_buscar" class="btn btn-dark ml-2"style="box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);">Buscar</button>
        </form>
    </div>

    <div>
        <div id="result" class="result" style="display: none;"></div>
            <!-- Aquí se mostrarán los datos del paciente -->
        </div>

        <div id="pendientesResult" class="pendientes-result"></div>
            <!-- Aquí se mostrarán los datos de la tabla pendientes -->
        </div>
    </div>

    <!-- Modal de opciones -->
<div id="modalOpciones" class="modal2" style="display: none; z-index: 9999;">
    <div class="modal-content">
        <h3>Selecciona una Opción</h3>
        <button id="generar-reporte-btn">Generar Reporte Completo</button>
        <button onclick="generarReporteHoy()">Generar Reporte del Día</button>
        <button onclick="menuReporteCyS()">Control y Seguimiento</button>
        <button onclick="cerrarModal()">Cancelar</button>
    </div>
</div>

    <!-- Modal reporte control y seguimiento -->
<div id="modalCyS" class="modal2" style="display: none; z-index: 9999;">
    <div class="modal-content d-flex justify-content-center align-items-center">
        <h6 class="my-3">Selecciona EPS</h6>
        <select id="CySeps" class="form-control form-eps form-inline-input w-75 mb-3" required>
        <option value="" selected disabled>Seleccione una opción</option>
        <option value="EMSSANAR EPS SAS">EMSSANAR EPS SAS</option>
        <option value="MALLAMAS EPS">MALLAMAS EPS</option>
        <option value="SANITAS EPS">SANITAS EPS</option>
        <option value="ASMET SALUD EPS">ASMET SALUD EPS</option>
        <option value="SOS SALUD">SOS SALUD</option>
        </select>
        <h6>Selecciona Fecha</h6>
        <input type="date" class="form-control w-75" id="CySdate">
        <button onclick="generarReporteCyS()">Control y Seguimiento</button>
        <button onclick="cerrarModal()">Cancelar</button>
    </div>
</div>

</body>
</html>

<script>
    const urlParams = new URLSearchParams(window.location.search);
    const username = urlParams.get('username') || 'Sin nombre';
    const sede = urlParams.get('sede') || 'Desconocida';

    // Mostrar el mensaje de bienvenida
    document.getElementById('username').setAttribute('registradopor',username);
    document.getElementById('username').innerText = `¡Bienvenid@ ${username} de la sede ${sede}!`;
    document.getElementById('sede_pendiente').value = `${sede}`;

    // -----------------------------------------------------------------------

    // -----------------------------------------------------------------------
    function goBack() {
        window.history.back();
    }
    // -----------------------------------------------------------------------

    c2 = document.getElementById('celular2');
    c1 = document.getElementById('Acelular1');
    function limitarCaracteres() {
        if (this.value.length > 10) {
            this.value = this.value.slice(0, 10); // Limita a 10 caracteres
        }
    };
    c1.addEventListener('input',limitarCaracteres)
    c2.addEventListener('input',limitarCaracteres)

    // -----------------------------------------------------------------------
    // Obtener el elemento input de fecha
    const inputFecha = document.getElementById('fecha_solicitud');
    
    // Crear un objeto de fecha actual
    const fechaActual = new Date();
    
    // Formatear la fecha en formato YYYY-MM-DD
    const year = fechaActual.getFullYear();
    const month = ('0' + (fechaActual.getMonth() + 1)).slice(-2); // Meses van de 0-11, por eso sumamos 1
    const day = ('0' + fechaActual.getDate()).slice(-2);
    
    const fechaFormateada = `${year}-${month}-${day}`;
    
    // Asignar la fecha actual como valor y como máximo permitido
    inputFecha.value = fechaFormateada;
    inputFecha.setAttribute("max", fechaFormateada);

    // Reporte CyS
    const inputFechaCyS = document.getElementById('CySdate');
    const formatearFecha = (fecha) => {
        const year = fecha.getFullYear();
        const month = String(fecha.getMonth() + 1).padStart(2, '0');
        const day = String(fecha.getDate()).padStart(2, '0');
        return `${year}-${month}-${day}`;
    };
    const primerDiaMes = formatearFecha(new Date(fechaActual.getFullYear(), fechaActual.getMonth(), 1));
    inputFechaCyS.min = primerDiaMes;
    inputFechaCyS.max = formatearFecha(fechaActual);
    inputFechaCyS.value = formatearFecha(fechaActual); // valor por defecto
    
    // -----------------------------------------------------------------------

    
    // Obtener el input de fecha
    const inputFechaFormula = document.getElementById('fechaFormula');

    // Obtener la fecha actual en formato YYYY-MM-DD
    const fechaActual2 = new Date().toISOString().split('T')[0];

    // Establecer la fecha máxima permitida
    inputFechaFormula.setAttribute("max", fechaActual2);

        // --------------------------------------------------------------------


    document.addEventListener('DOMContentLoaded', () => {
        const identificacionInput = document.querySelector('input.identificacion'); // Campo de identificación
        const tipoIdInput = document.querySelector('.form-id'); // Campo tipo identificación
        const pacienteInput = document.querySelector('.form-paciente'); // Campo primer nombre
        const celularInput = document.querySelector('.form-telefono'); // Campo celular
        const eps = document.querySelector('.form-eps'); // Campo eps

        const diagnosticoInput = document.querySelector('input.diagnostico'); 
        const nombreDiagnosticoInput = document.querySelector('.form-nombre-diagnostico');  

        identificacionInput.addEventListener('blur', () => {
    const numeroIdentificacion = identificacionInput.value.trim();
    if (numeroIdentificacion) {
        fetch(`/api/paciente?numeroIdentificacion=${numeroIdentificacion}`)
            .then(response => {
                if (!response.ok) {
                    throw new Error('Paciente no encontrado');
                }
                return response.json();
            })
            .then(data => {
                tipoIdInput.value = data.tipoIdentificacion || '';
                pacienteInput.value = data.primerNombre || '';
                celularInput.value = data.telefono || '';
                eps.value = data.eps || '';
            })
            .catch(error => {
                console.error('Error:', error);
                Swal.fire({
                            title: "Paciente no Encontrado",
                            text: "Registrar en Agregar Paciente",
                            icon: "warning"
                            })

                // Limpia los campos del formulario
                identificacionInput.value = '';
                tipoIdInput.value = '';
                pacienteInput.value = '';
                celularInput.value = '';
                eps.value = '';
            });
    }
});

const identificacionAgregarU = document.getElementById('Aidentificacion');
// Agregar paciente validacion
identificacionAgregarU.addEventListener('blur', () => {
    const numeroIdentificacion = identificacionAgregarU.value.trim();
    if (numeroIdentificacion) {
        fetch(`/api/paciente?numeroIdentificacion=${numeroIdentificacion}`)
            .then(response => {
                    if (response.ok) {
                        Swal.fire({
                            title: "Ya existe el paciente con esta identificación.",
                            icon: "warning"
                            })
                        identificacionAgregarU.value = "";
                    }
                    return response.json();
                })
    }
});

        diagnosticoInput.addEventListener('blur', () => {
        const idDiagnostico = diagnosticoInput.value.trim();
        if (idDiagnostico) {
            fetch(`/api/diagnostico?codigo=${idDiagnostico}`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Diagnóstico no encontrado');
                    }
                    return response.json();
                })
                .then(data => {
                    nombreDiagnosticoInput.value = data.nombre || ''; // Llena el campo de nombre con el resultado
                })
                .catch(error => {
                    console.error('Error:', error);
                    nombreDiagnosticoInput.value = ''; // Vacia el campo en caso de error
                });
        };
    });
});

let nombresMedicamentos = [];

// Configuración de Awesomplete
const medicamentoInput = document.getElementById('medicamento');
const awesomplete = new Awesomplete(medicamentoInput, {
    minChars: 2,
    autoFirst: true,
    maxItems: Infinity
});

// Cargar nombres de medicamentos al enfocarse en el input
medicamentoInput.addEventListener('focus', function () {
    if (nombresMedicamentos.length === 0) { 
        fetch('/api/medicamentos/nombres')
            .then(response => response.json())
            .then(data => {
                nombresMedicamentos = data;
            })
            .catch(error => console.error('Error al cargar nombres de medicamentos:', error));
    }
});

// Filtrar medicamentos en el cliente mientras el usuario escribe
medicamentoInput.addEventListener('input', function () {
    const query = this.value.toLowerCase();
    if (query.length > 1) {
        const filteredMedicamentos = nombresMedicamentos.filter(nombre =>
            nombre.toLowerCase().includes(query)
        );

        // Actualizar la lista de Awesomplete
        awesomplete.list = filteredMedicamentos;
    }
});

// Evento para validar el campo cuando pierda el foco
medicamentoInput.addEventListener('blur', function () {
    const valorIngresado = this.value.trim();

    // Verificar si el valor ingresado está en la lista de medicamentos
    if (!nombresMedicamentos.includes(valorIngresado)) {
        Swal.fire({
            title: "Error",
            html: "Por Favor Selecciona un Medicamento de la Lista.",
            icon: "warning",
            confirmButtonText: "Aceptar"
        }).then(() => {
            this.value = ''; // Borra el valor incorrecto 
        });
    }
});


// Evento para seleccionar un medicamento de la lista
medicamentoInput.addEventListener('awesomplete-selectcomplete', function () {
    const selectedMedicamento = this.value;
    cargarDetallesMedicamento(selectedMedicamento);
});

// Función para cargar los detalles de un medicamento
function cargarDetallesMedicamento(nombreMedicamento) {
    fetch(`/api/medicamentos/detalles?nombre=${encodeURIComponent(nombreMedicamento)}`)
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                console.error(data.error);
                return;
            }
            // Rellenar los campos con los datos recibidos
            document.getElementById('laboratorio').value = data.laboratorio || '';
            document.getElementById('tipo_producto').value = data.tipoproducto || '';
            document.getElementById('cobertura').value = data.cobertura || '';
            document.getElementById('cum').value = data.cum || '';
        })
        .catch(error => console.error('Error al cargar detalles del medicamento:', error));
}


document.getElementById('AU_sede2').addEventListener('input', function() {
    const query = this.value.toLowerCase(); // Convertir a minúsculas para una comparación más flexible
    if (query.length > 1) {
        fetch(`/api/sedes`)
        .then(response => response.json())
        .then(data => {
            const list = document.getElementById('sedes_lista1');
            list.innerHTML = ''; // Limpiar la lista actual

            // Filtrar sedes que contengan el texto ingresado
            const filteredSedes = data.filter(sede => 
                sede.nombresede.toLowerCase().includes(query)
            );

            // Crear los elementos de la lista (li) solo con los medicamentos que coincidan
            filteredSedes.forEach(sede => {
                const listItem = document.createElement('li');
                listItem.textContent = sede.nombresede; // Nombre del sede

                // Al hacer clic en un elemento de la lista, seleccionamos el medicamento
                listItem.addEventListener('click', function() {
                    // Llenamos el campo de búsqueda con el nombre seleccionado
                    document.getElementById('AU_sede2').value = listItem.textContent;
                    // Limpiar la lista una vez seleccionado el medicamento
                    list.innerHTML = '';
                });
                list.appendChild(listItem); // Añadir el elemento a la lista
            });
            // Si no hay resultados, mostrar un mensaje
            if (filteredSedes.length === 0) {
                const noResult = document.createElement('li');
                noResult.textContent = 'No se encontraron sedes.';
                list.appendChild(noResult);
            }
        })
        .catch(error => console.error('Error:', error));
    } else {
        document.getElementById('medicamentos-list').innerHTML = ''; // Limpiar la lista si el input tiene menos de 2 caracteres
    }
});

document.getElementById('AU_sede').addEventListener('input', function() {
    const query = this.value.toLowerCase(); // Convertir a minúsculas para una comparación más flexible
    if (query.length > 1) {
        fetch(`/api/sedes`)
        .then(response => response.json())
        .then(data => {
            const list = document.getElementById('sedes_lista');
            list.innerHTML = ''; // Limpiar la lista actual
            // Filtrar sedes que contengan el texto ingresado
            const filteredSedes = data.filter(sede => 
                sede.nombresede.toLowerCase().includes(query)
            );
            // Crear los elementos de la lista (li) solo con los medicamentos que coincidan
            filteredSedes.forEach(sede => {
                const listItem = document.createElement('li');
                listItem.textContent = sede.nombresede; // Nombre del sede
                // Al hacer clic en un elemento de la lista, seleccionamos el medicamento
                listItem.addEventListener('click', function() {
                    // Llenamos el campo de búsqueda con el nombre seleccionado
                    document.getElementById('AU_sede').value = listItem.textContent;
                    // Limpiar la lista una vez seleccionado el medicamento
                    list.innerHTML = '';
                });
                list.appendChild(listItem); // Añadir el elemento a la lista
            });
            // Si no hay resultados, mostrar un mensaje
            if (filteredSedes.length === 0) {
                const noResult = document.createElement('li');
                noResult.textContent = 'No se encontraron sedes.';
                list.appendChild(noResult);
            }
        })
        .catch(error => console.error('Error:', error));
    } else {
        document.getElementById('medicamentos-list').innerHTML = ''; // Limpiar la lista si el input tiene menos de 2 caracteres
    }
});



document.getElementById('btn_cantidad_pendiente').addEventListener('click', function() {
    // Obtener los valores de los campos
    
    const producto = document.getElementById('medicamento').value;
    const laboratorio = document.getElementById('laboratorio').value;
    const cantidadPendiente = document.getElementById('cantidad_pendiente').value;
    const controlMensual = document.getElementById('controlMensual').value;
    const numeroFormula = document.getElementById('numeroFormula').value;
    const fechaRegistro = document.querySelector('input[type="date"]').value;
    const identificacion = document.querySelector('.identificacion').value;
    const tipoIdentificacion = document.querySelector('.form-id').value;
    const nombre = document.querySelector('.form-paciente').value;
    const tipoProducto = document.getElementById('tipo_producto').value;
    const cobertura = document.getElementById('cobertura').value;
    const cantidadPrescrita = document.getElementById('cantidad_prescrita').value;
    const tipoEntrega = document.getElementById('tipoEntrega').value;
    const sedePendiente = document.getElementById('sede_pendiente').value;
    const estadoDispensacion = document.getElementById('estado-dis').value;
    const cum = document.getElementById('cum').value;
    const observacion = document.getElementById('observacion').value;
    const fechaFormula = document.getElementById('fechaFormula').value;
    const codigoDiagnositco = document.getElementById('codigoDiagnostico').value;
    const nombreDiagnostico = document.getElementById('nombreDiagnostico').value;
    const direccion = document.getElementById('direccion').value;
    const modalidad = document.getElementById('modalidad').value;
    const plan = document.getElementById('planSOS').value;


    // Array para almacenar los mensajes de error
    let missingFields = [];

    // Verificar qué campos están vacíos
    if (!identificacion) missingFields.push('Identificación');
    if (!numeroFormula) missingFields.push('Número de fórmula');
    if (!direccion) missingFields.push('Dirección');
    if (!modalidad) missingFields.push('Modalidad');
    if (!codigoDiagnositco) missingFields.push('Codigo diagnóstico');
    if (!plan) missingFields.push('Plan');
    if (!fechaFormula) missingFields.push('Fecha de fórmula');
    if (!producto) missingFields.push('Medicamento');
    if (!cantidadPrescrita) missingFields.push('Cantidad prescrita');
    if (!controlMensual) missingFields.push('Control Mensual');
    if (!cantidadPendiente) missingFields.push('Cantidad pendiente');

    // Si hay campos faltantes, mostrar un mensaje
    if (missingFields.length > 0) {
            Swal.fire({
                title: "Campos Obligatorios",
                html: "Por favor completa los siguientes campos obligatorios: <br> - " + missingFields.join(' <br> - '),
                icon: "warning",
                confirmButtonText: "Aceptar"
            });
            return;
        }

    // Reiniciar los inputs
    
    document.getElementById("medicamento").value = "";
    document.getElementById("laboratorio").value = "";
    document.getElementById("tipo_producto").value = "";
    document.getElementById("cobertura").value = "";
    document.getElementById("cantidad_prescrita").value = "";
    document.getElementById("cum").value = "";
    document.getElementById("observacion").value = "";
    document.getElementById("cantidad_pendiente").value = "";
    document.getElementById("controlMensual").value = "";


    // Crear una nueva fila (tr)
    const nuevaFila = document.createElement('tr');
    nuevaFila.style.backgroundColor = '#ffffff'; // Fondo blanco

    // Crear las celdas (td) para la fila
    nuevaFila.innerHTML = `
        
        <td>${producto}</td>
        <td>${laboratorio}</td>
        <td class="text-center">${cantidadPendiente}</td>
        <td class="text-center" style="display: none;">${tipoProducto}</td>
        <td class="text-center" style="display: none;">${cobertura}</td>
        <td class="text-center" style="display: none;">${cantidadPrescrita}</td>
        <td class="text-center" style="display: none;">${tipoEntrega}</td>
        <td class="text-center" style="display: none;">${estadoDispensacion}</td>
        <td class="text-center" style="display: none;">${cum}</td>
        <td class="text-center" style="display: none;">${observacion}</td>
        <td class="text-center" style="display: none;">${controlMensual}</td>
    `;

    // Agregar la funcionalidad para eliminar la fila al hacer clic
    nuevaFila.addEventListener('click', function() {
        // Crear el modal personalizado para confirmar la eliminación
        const modal = document.createElement('div');
        modal.style.background = 'white';
        modal.style.padding = '20px';
        modal.style.borderRadius = '5px';
        modal.style.width = '230px';
        modal.style.margin = 'auto';
        modal.style.position = 'fixed';
        modal.style.top = '50%';
        modal.style.left = '50%';
        modal.style.transform = 'translate(-50%, -50%)';
        modal.style.boxShadow = '0 4px 10px rgba(0, 0, 0, 0.2)';
        modal.style.zIndex = '9999'; // Asegura que el modal esté encima de todo

        // Mensaje del modal
        const mensaje = document.createElement('p');
        mensaje.id = 'modalMessage';
        mensaje.textContent = '¿Deseas eliminar esta fila?';
        modal.appendChild(mensaje);

        // Botón de aceptar
        const botonAceptar = document.createElement('button');
        botonAceptar.id = 'closeModal';
        botonAceptar.textContent = 'Aceptar';
        botonAceptar.style.background = '#0ac150';
        botonAceptar.style.color = 'white';
        botonAceptar.style.border = 'none';
        botonAceptar.style.padding = '10px';
        botonAceptar.style.borderRadius = '5px';
        botonAceptar.style.cursor = 'pointer';
        modal.appendChild(botonAceptar);

        // Botón de cancelar
        const botonCancelar = document.createElement('button');
        botonCancelar.textContent = 'Cancelar';
        botonCancelar.style.background = '#dc3545';
        botonCancelar.style.color = 'white';
        botonCancelar.style.border = 'none';
        botonCancelar.style.padding = '10px';
        botonCancelar.style.borderRadius = '5px';
        botonCancelar.style.cursor = 'pointer';
        botonCancelar.style.marginLeft = '10px';
        modal.appendChild(botonCancelar);

        // Agregar el modal al documento
        document.body.appendChild(modal);

        // Función para eliminar la fila y cerrar el modal al hacer clic en "Aceptar"
        botonAceptar.addEventListener('click', () => {
            nuevaFila.remove(); // Eliminar la fila
            modal.remove(); // Cerrar el modal
        });

        // Cerrar el modal al hacer clic en "Cancelar"
        botonCancelar.addEventListener('click', () => {
            modal.remove(); // Cerrar el modal
        });
    });

    // Agregar la nueva fila al cuerpo de la tabla
    document.getElementById('tabla-productos').appendChild(nuevaFila);
});

    // Enviar datos a la db

    document.getElementById('guardar-btn').addEventListener('click', function() {

        // Obtener los valores de los campos
        const numeroFormula = document.getElementById('numeroFormula').value;
        const fecharegistro = document.querySelector('input[type="date"]').value;
        const identificacion = document.querySelector('.identificacion').value;
        const fechaFormula = document.getElementById('fechaFormula').value;
        const codigodiagnostico = document.getElementById('codigoDiagnostico').value;
        const diagnostico = document.getElementById('nombreDiagnostico').value;
        const direccion = document.getElementById('direccion').value;
        const modalidad = document.getElementById('modalidad').value;
        const plansos = document.getElementById('planSOS').value;
        const tipoidentificacion = document.getElementById('tipoIdentificacion').value;
        const nombre = document.getElementById('nombrePaciente').value;
        const sedependiente = document.getElementById('sede_pendiente').value;
        const numeroformula = document.getElementById('numeroFormula').value;
        const celular = document.getElementById('celular1').value;
        const eps = document.getElementById('eps').value;
        const celular2 = document.getElementById('celular2').value;
        const ambito = document.getElementById('ambito').value;
        const nitips = document.getElementById('NITIPS').value;
        const nombreips = document.getElementById('nombreIPS').value;
        const fechaformula = document.getElementById('fechaFormula').value;
        const registradopor = document.getElementById('username').getAttribute('registradopor');


        // Array para almacenar los mensajes de error
        let missingFields = [];

        // Verificar qué campos están vacíos
        if (!identificacion) missingFields.push('Identificación');
        if (!numeroFormula) missingFields.push('Número de fórmula');
        if (!direccion) missingFields.push('Dirección');
        if (!modalidad) missingFields.push('Modalidad');
        if (!codigodiagnostico) missingFields.push('Codigo diagnóstico');
        if (!plansos) missingFields.push('Plan');
        if (!fechaFormula) missingFields.push('Fecha de fórmula');
        // if (!fechaRegistro) missingFields.push('Fecha de registro');
        // if (!diagnostico) missingFields.push('Nombre diagnóstico');

        // Si hay campos faltantes, mostrar un mensaje
        if (missingFields.length > 0) {
                Swal.fire({
                    title: "Campos Obligatorios",
                    html: "Por favor completa los siguientes campos obligatorios: <br> - " + missingFields.join(' <br> - '),
                    icon: "warning",
                    confirmButtonText: "Aceptar"
                });
                return;
            }
        
            const filas = document.querySelectorAll('#tabla-productos tr'); // Obtener las filas de la tabla
            
            // Validar si hay al menos una fila
            if (filas.length === 0) {
                Swal.fire({
                    title: "Aviso",
                    text: "Debe tener al menos un medicamento registrado en la tabla de pendientes",
                    icon: "warning",
                    confirmButtonText: "Aceptar"
                });
                return; // Detener el flujo
            }
        document.getElementById('guardar-btn').disabled = true;
        // Obtener los valores de los inputs
        fetch('/api/pendientes/ultimoNumeroFactura')
    .then(response => response.json())
    .then(facturaData => {
        const numerofactura = parseInt(facturaData.numeroFactura)+1;
        
        filas.forEach(fila => {
        const celdas = fila.children;
            // Extraer los datos de cada celda (td)
            // const fechaRegistro = celdas[4].innerText;
            // const identificacion = celdas[5].innerText;
            // const tipoIdentificacion = celdas[6].innerText;
            // const nombre = celdas[7].innerText;            
            //const codigoproducto = celdas[0].innerText;
            const medicamento = celdas[0].innerText;
            const laboratorio = celdas[1].innerText;
            const cantidadpendiente= celdas[2].innerText;
            const tipoproducto = celdas[3].innerText;
            const cobertura = celdas[4].innerText;
            const cantidadprescrita = celdas[5].innerText;
            const tipoentrega = celdas[6].innerText;
            // const sedependiente = celdas[12].innerText;
            const estadodispensacion = celdas[7].innerText;
            const cum = celdas[8].innerText;
            const observacion = celdas[9].innerText;
            const controlmensual = celdas[10].innerText;

        const data = {
            fecharegistro,
            identificacion,
            tipoidentificacion,
            nombre,
            medicamento,
            cantidadpendiente,
            controlmensual,
            numerofactura,
            tipoproducto,
            cobertura,
            cantidadprescrita,
            tipoentrega,
            sedependiente,
            estadodispensacion,
            cum,
            observacion,
            numeroformula,
            celular,
            celular2,
            direccion,
            ambito,
            nitips,
            nombreips,
            modalidad,
            codigodiagnostico,
            diagnostico,
            plansos,
            fechaformula,
            laboratorio,
            eps,
            registradopor
        };

        // Enviar los datos al servidor
        fetch('/api/pendientes', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(data) // Asegúrate de incluir el cuerpo de la solicitud
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('Error en la solicitud: ' + response.statusText);
            }
            return response.json();
        })
        .then(data => {
            // Mostrar el modal de éxito
            document.getElementById('modalMessage').innerText = `Datos guardados correctamente Número de documento ${numerofactura}`;
            document.getElementById('successModal').style.display = 'flex';
            document.getElementById('guardar-btn').disabled = false;
        })
        .catch(error => console.error('Error:', error));

        // Manejar el botón de cerrar del modal
        document.getElementById('closeModal').addEventListener('click', function() {
            document.getElementById('successModal').style.display = 'none';
            location.reload();
        });
    });
    })
    .catch(error => console.error('Error al obtener el último número de factura:', error));
});

// Enviar a la bd pacientes

// document.getElementById('agregar-paciente-btn-1').addEventListener('click', function() {
//     document.getElementById("consulta_usuario").style.display = 'none';
//     document.getElementById("id_formulario_principal").style.display = 'none';
//     document.getElementById("pendientesResult").style.display = 'none';
//     document.getElementById("result").style.display = 'none';
//     document.getElementById("agregar_usuario").style.display = 'block';
//     document.getElementById("texto_principal").innerText = 'Agregar Paciente';
// });

document.getElementById('agregar-paciente-btn').addEventListener('click', function() {

        // const idpaciente = parseInt(ultimoIdpaciente.idpaciente)+1;
        const identificacion = document.getElementById('Aidentificacion').value;
        const nombre = document.getElementById('AnombrePaciente').value.toUpperCase();
        const tipoIdentificacion = document.getElementById('AtipoIdentificacion').value;
        const telefono = document.getElementById('Acelular1').value;
        const eps = document.getElementById('Aeps').value;

         // Array para almacenar los mensajes de error
         let missingFields = [];
            
            if (!identificacion) missingFields.push('Identificación');
            if (!tipoIdentificacion) missingFields.push('Tipo Identificación');
            if (!nombre) missingFields.push('Nombre del Paciente');
            if (!telefono) missingFields.push('Celular');
            if (!eps) missingFields.push('Eps');
            
            if (missingFields.length > 0) {
                    Swal.fire({
                        title: "Campos Obligatorios",
                        html: "Por favor completa los siguientes campos obligatorios: <br> - " + missingFields.join(' <br> - '),
                        icon: "warning",
                        confirmButtonText: "Aceptar"
                    });
                    return;
                }
        // Crear el objeto de datos
        const data = {
            identificacion,
            tipoidentificacion: tipoIdentificacion,
            nombre,
            telefono,
            eps
        };
        
        // Enviar los datos al servidor
        fetch('/api/pacientes', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(data) // Asegúrate de incluir el cuerpo de la solicitud
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('Error en la solicitud: ' + response.statusText);
            }
            return response.json();
        })
        .then(data => {
            // Mostrar el modal de éxito
            Swal.fire({
                        title: "Datos guardados correctamente",
                        icon: "success",
                        confirmButtonText: "Aceptar"
                    }).then((result) => {
                        if (result.isConfirmed) {
                            location.reload();
                        }
                    });
        })
        .catch(error => console.error('Error:', error));

        // Manejar el botón de cerrar del modal
        document.getElementById('closeModal').addEventListener('click', function() {
            document.getElementById('successModal').style.display = 'none';
            location.reload();
        });
    });

    // Evento para mostrar el formulario cuando se haga clic en el botón "Consulta Pendientes"
    document.getElementById("consulta-btn").addEventListener("click", function() {
        // Mostrar el formulario de consulta
        document.getElementById("consulta_usuario").style.display = 'block';
        document.getElementById("id_formulario_principal").style.display = 'none';
        document.getElementById("agregar_usuario").style.display = 'none';
        document.getElementById("texto_principal").innerText = 'Consulta Pendiente';
    });

    document.getElementById("facturacion-btn").addEventListener("click", function() {
        // Mostrar el formulario de consulta
        location.reload();
    });

    // Boton para consultar pacientes
    document.getElementById('form_consultar').addEventListener('submit', function(event) {
    event.preventDefault();  // Evitar que el formulario se envíe de forma tradicional

    const identificacion = document.getElementById('identificacion_c').value;

    // Realizar una solicitud AJAX para buscar la identificación
    fetch(`/buscar-pendientes?identificacion=${identificacion}`)
        .then(response => response.json())
        .then(data => {
            const resultDiv = document.getElementById('result');
            const pendientesDiv = document.getElementById('pendientesResult'); // Div para mostrar pendientes
            
            // Verifica si hay un mensaje de error en los datos del paciente
            if (data.message) {
                Swal.fire({
                            title: "Paciente no encontrado!",
                            icon: "error"
                        });
                resultDiv.style.display = 'none';
                pendientesDiv.style.display = 'none'; // Oculta los resultados de pendientes
                return;
            }
            // Mostrar los datos del paciente
            resultDiv.innerHTML = `
    <div class="container mt-3">
        <h2 style="color: #333;text-shadow: 0 4px 8px rgba(0, 0, 0, 0.3); font-weight: bold; text-align: center;">Datos del Paciente</h2>
        <div class="row justify-content-between align-items-center" 
            style="background-color: #FFF6D9; box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2); border-radius: 20px; padding: 20px; font-size: 14px; border: 1px solid #E4B93E;">
            <div class="col-md-4">
                <p><strong>Tipo de Identificación:</strong> ${data.paciente.tipoidentificacion}</p>
                <p><strong>Numero Identificación:</strong> ${data.paciente.identificacion}</p>
                <p><strong>EPS:</strong> ${data.paciente.eps || ''}</p>
            </div>
            <div class="col-md-4">
                <p><strong>Nombre:</strong> ${data.paciente.nombre}</p>
                <p><strong>Dirección:</strong> ${data.pendientes.length > 0 ? data.pendientes[0].direccion : 'Dirección no disponible'}</p>
            </div>
            <div class="col-md-4">
                <p><strong>Celular:</strong> ${data.paciente.telefono}</p>
                <p><strong>Celular 2:</strong> ${data.pendientes.length > 0 ? data.pendientes[0].celular2 : 'Celular no disponible'}</p>
            </div>
        </div>
    </div>
`;

// Mostrar los datos de la tabla pendientes
if (data.pendientes.length > 0) {
    pendientesDiv.innerHTML = `
    <h2 style="color: #333;text-shadow: 0 4px 8px rgba(0, 0, 0, 0.3); font-weight: bold; text-align: center;" class="mt-3">Medicamentos Pendientes</h2>
    <div class="container mt-3">
    <div class="formulario_principal_consulta">
    <div class="row mt-2">
                <div class="col-md-12 d-flex justify-content-center align-items-center flex-column">
                    <table class="table table-bordered">
                        <thead class="text-center" style="background-color:#FFF6D9;">
                            <tr>
                                <th>Nº Pendiente</th>
                                <th class="">Fecha Registro</th>
                                <th class="">Fecha Formula</th>
                                <th class="w-75">Medicamento</th>
                                <th>Sede pendiente</th>
                                <th>Cantidad Prescrita</th>
                                <th>Cantidad Pendiente</th>
                                <th>Cantidad Entregada</th>
                                <th style="background-color:#dc3545;color: white;">Cantidad Pendiente Final</th>
                                <th>Observación</th>
                                <th style="display: none; border: none;" class='header-btn-basura'></th>
                            </tr>
                        </thead>
                        <tbody id="tabla-productos">
                            ${data.pendientes.map((p, index)=> `
                <tr style="border-bottom: 1px solid #E4B93E; background-color:white;">
                    <td class='d-none data-idpendiente'>${p.idpendientes}</td>
                    <td style="padding: 10px; border: 1px solid #E4B93E; text-align:center;">${p.numerofactura}</td>
                    <td style="padding: 10px; border: 1px solid #E4B93E; text-align:center;">${new Date(p.fecharegistro).toISOString().split('T')[0]}</td>
                    <td style="padding: 10px; border: 1px solid #E4B93E; text-align:center;">${new Date(p.fechaformula).toISOString().split('T')[0]}</td>
                    <td style="padding: 10px; border: 1px solid #E4B93E;">${p.medicamento}</td>
                    <td style="padding: 10px; border: 1px solid #E4B93E;">${p.sedependiente}</td>
                    <td style="padding: 10px; border: 1px solid #E4B93E; text-align:center;">${p.cantidadprescrita}</td>
                    <td style="padding: 10px; border: 1px solid #E4B93E; text-align:center;" class="cantidadPendiente">${p.cantidadpendiente}</td>
                    <td style="padding: 10px; border: 1px solid #E4B93E;">
                        <input type="text" style="width: 100%; padding: 5px;" id="cantidadEntregada-${index}" oninput="calcularPendienteFinal(${index},${p.idpendientes})" class="cantidad-entregada">
                    </td>
                    <td class="facturaSI" style="display:none; padding: 10px; border: 1px solid #E4B93E;">
                    <td style="padding: 10px; border: 1px solid #E4B93E; text-align:center;" class="tdPendientesFinal" id="cantidadPendienteFinalTD-${index}"> <p class="m-0 pendientesFinal" id="cantidadPendienteFinal-${index}">${p.cantidadpendientefinal || '0'}</p> </td>
                    <td style="padding: 10px; border: 1px solid #E4B93E; text-align:center;">
                        <textarea class="data-observacion" id="observacion-${index}">${p.observacion || ''}</textarea>
                    </td>
                    <td style="display: none;"><button class="btn-basura btn-dark" style="display: none;">
                    <i class="fas fa-trash"></i>    
                    </buttton></td>
                </tr>
            `
        ).join('')}
                        </tbody>
                    </table>
                    <button type="submit" id="btn_actualizar" class="btn btn-dark ml-2">Actualizar</button>
                </div>
            </div>            
        </div>
    </div>
    `;

            } else {    
                pendientesDiv.innerHTML = `
                <div class="f-flex justify-content-center text-center">
                    <h3>No hay pendientes para esta identificación.</h3>
                <div/>
                `;
            }

            // NEW Cambia el color de las celdas
            const cpf_styles = document.querySelectorAll('.tdPendientesFinal');
            const inputs_des = document.querySelectorAll('.cantidad-entregada');
            const textarea_des = document.querySelectorAll('.data-observacion');
            cpf_styles.forEach((celda,index) => {
                // Verifica si el valor de la celda es 0
                if (parseInt(celda.textContent) === 0) {
                    // Cambia el fondo de la celda a verde
                    celda.style.backgroundColor = '#5edd9e';
                    inputs_des[index].disabled = true;
                    textarea_des[index].disabled = true;
                }
            });

            inputs_des.forEach(input => {
                input.addEventListener('blur', async () => {
                    const fila = input.closest('tr');
                    const idpendientes = fila.querySelector('.data-idpendiente')?.textContent.trim();
                    const cantidadentregada = input.value.trim();
                    if (cantidadentregada !== '' && parseInt(cantidadentregada) !== 0) {
                        const { value: numeroFormula } = await Swal.fire({
                            title: 'Número de Factura Salud IPS',
                            input: 'text',
                            inputLabel: 'Ingrese el número de Factura de Salud IPS:',
                            showCancelButton: true,
                            inputValidator: (value) => {
                                if (!value) {
                                    return 'Debe ingresar un número';
                                }
                            }
                        });

                        if (numeroFormula) {
                            const inputFormula = fila.querySelector('.facturaSI');
                            if (inputFormula) {
                                inputFormula.textContent = numeroFormula;
                            }
                        } else {
                            console.log("No se ingreso el numero de formula: ", numeroFormula)
                            input.value = '';
                        }
                    }
                });
            });

            document.querySelectorAll('.btn-basura').forEach(button => {
                if (role == 'superUser') {
                    document.querySelector('.header-btn-basura').style.display = 'flex';
                    button.parentElement.style.display = 'block';
                    button.style.display = 'block';
                    button.addEventListener('click', function(event) {
                        setTimeout(() => {
                            // Obtener el td más cercano al botón clickeado (esto sube hasta la fila completa)
                            const td = event.target.closest('td');
                            
                            // Obtener la fila completa (tr)
                            const tr = td.closest('tr');
                            
                            // Obtener los datos de esa fila, por ejemplo:
                            const numeroFactura = tr.querySelector('td:nth-child(2)').textContent;
                            const medicamento = tr.querySelector('td:nth-child(5)').textContent;
                            const id = tr.querySelector('td:nth-child(1)').textContent;
                            const idpendientes = parseInt(id)

                            // Mostrar mensaje de confirmación
                            let isConfirmed = false; // Inicializamos la variable


                            Swal.fire({
                                title: "¿Estás Seguro que Deseas Eliminar?",
                                html: `
                                    <p>El número de pendiente <strong>${numeroFactura}</strong>, con medicamento <strong>${medicamento}</strong>.</p>
                                    <hr>
                                    <p><strong>Selecciona una razón para eliminar:</strong></p>
                                    <div style="text-align: left;">
                                        <label><input type="radio" name="razon" value="ERROR REGISTRO"> Error de digitación</label><br>
                                        <label><input type="radio" name="razon" value="PACIENTE NO CONTACTADO"> No se logra contacto con paciente</label><br>
                                        <label><input type="radio" name="razon" value="RECHAZO DOMICILIO Y NO ASISTE"> Paciente rechaza servicio a domicilio y no se presenta en sala</label>
                                    </div>
                                `,
                                icon: "warning",
                                showCancelButton: true,
                                confirmButtonColor: "#3085d6",
                                cancelButtonColor: "#d33",
                                confirmButtonText: "Sí, eliminarlo!",
                                preConfirm: () => {
                                    const razon = document.querySelector('input[name="razon"]:checked');
                                    if (!razon) {
                                        Swal.showValidationMessage("Debes seleccionar una razón antes de eliminar.");
                                        return false;
                                    }
                                    return razon.value;
                                }
                            }).then((result) => {
                                if (result.isConfirmed) {
                                    const razonSeleccionada = result.value;

                                    fetch('/mover-a-reciclaje-pendientes', {
                                        method: 'POST',
                                        headers: {
                                            'Content-Type': 'application/json'
                                        },
                                        body: JSON.stringify({
                                            username: username,
                                            id: idpendientes,
                                            razon: razonSeleccionada  // añadimos la razón
                                        })
                                    })
                                    .then(response => response.json())
                                    .then(data => {
                                        if (data.success) {
                                            tr.remove();
                                            console.log(`Fila con ID ${idpendientes} eliminada.`);
                                            Swal.fire({
                                                title: "¡Eliminado!",
                                                text: "El Pendiente ha sido Eliminado.",
                                                icon: "success"
                                            });
                                        } else {
                                            alert('Error al mover el registro: ' + data.message);
                                        }
                                    })
                                    .catch(error => {
                                        console.error('Error en la solicitud:', error);
                                        alert('Hubo un error al intentar mover el registro');
                                    });

                                } else {
                                    isConfirmed = false;
                                }
                            });

                            
                        }, 0);
                    });
                }// fin del if superUser
            });

            // Mostrar el resultado
            resultDiv.style.display = 'block'; // Asegúrate de que el resultado del paciente se muestre
            pendientesDiv.style.display = 'block'; // Asegúrate de que se muestre el div de pendientes
            // Capturar el botón una vez que el contenido dinámico ha sido insertado en el DOM.
            const actualizarBtn = document.getElementById('btn_actualizar');
            if (actualizarBtn) {
                actualizarBtn.addEventListener('click', function (event) {
                    event.preventDefault(); // Evitar que el formulario se recargue

                    // Capturar todas las filas del input
                    const rows = document.querySelectorAll('.cantidad-entregada');
                    const pendientesFinales = document.querySelectorAll('.pendientesFinal');

                    let updates = [];
                    let updatesObs = [];

                    rows.forEach((row, index) => {
                        const fila = row.closest('tr');

                        const idpendientes = fila.querySelector('.data-idpendiente')?.textContent.trim();
                        const observacion = fila.querySelector('textarea')?.value.trim();

                        const cantidadentregada = row.value.trim();
                        // const cantidadpendientefinal = pendientesFinales[index].textContent;
                        const cantidadpendientefinal = fila.querySelector('.pendientesFinal')?.textContent.trim();

                        if (cantidadentregada !='' && cantidadentregada != 0) {
                            updates.push({
                                idpendientes: idpendientes,
                                cantidadentregada: cantidadentregada,
                                cantidadpendientefinal: cantidadpendientefinal
                            });
                        }
                        if (observacion != '') {
                            updatesObs.push({
                                idpendientes: idpendientes,
                                observacion: observacion
                            });
                        }
                        // Si la CPF==0 entonces hace que el input se inhabilite
                        if (cantidadpendientefinal == 0){
                            const input = document.getElementById(`cantidadEntregada-${index}`)
                            const textarea= document.getElementById(`observacion-${index}`)
                            input.disabled = true;
                            textarea.disabled = true;
                        }
                    });

                    // Enviar datos al backend
                    fetch('/api/actualizar-cantidad-entregada', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ updates: updates })
                    })
                    .then(response => response.json())
                    .then(data1 => {
                        if (data1.success) {
                            const inputs = document.querySelectorAll('.cantidad-entregada')
                            inputs.forEach(input => {
                                input.value = '';
                            });  
                            Swal.fire({
                                title: "Se actualizaron los datos correctamente",
                                icon: "success"
                                });
                        } else {
                            alert('Error al actualizar los datos.');
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                    });
                    // Enviar datos de las observaciones al backend
                    fetch('/api/actualizar-observacion-pendiente', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ updates: updatesObs })
                    })
                    .then(response => response.json())
                    .then(data1 => {
                        if (data1.success) {
                            console.log('Se actualizaron los datos de observaciones correctamente.')
                        } else {
                            console.log('Error al actualizar los datos.')
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                    });
                    
                    // // ---------------------------------------------------------------------
                    rows.forEach(input => {
                        const fila = input.closest('tr');

                        const cantidadentregada = input.value.trim(); // Captura el valor del input
                        const idpendientes = fila.querySelector('.data-idpendiente')?.textContent.trim();
                        const facturaSI = fila.querySelector('.facturaSI')?.textContent.trim();

                        // Verifica que el input no esté vacío
                        if (cantidadentregada && cantidadentregada != 0){
                            // Enviar la solicitud al servidor
                            fetch('/actualizar-cantidad', {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                },
                                body: JSON.stringify({ cantidadentregada, idpendientes, username, facturaSI}),
                            })
                            .then(response => {
                                if (!response.ok) {
                                    throw new Error('Error al actualizar la cantidad');
                                }
                                return response.json();
                            })
                            .then(data => {
                                console.log('Respuesta del servidor:', data);
                                // alert(data.message);
                            })
                            .catch(error => {
                                console.error('Error:', error);
                                // alert('Error al actualizar la cantidad');
                            });
                        }   
                    });
                });
            } else {
                console.error('No se encontró el botón btn_actualizar.');
            }
        });
    });

function validarPrescritoDispensado(){
    const valorPendiente = parseInt(document.getElementById('cantidad_pendiente').value);
    const valorPrescrito = parseInt(document.getElementById('cantidad_prescrita').value);
    if ( valorPendiente != 0 && valorPrescrito) {
        if (valorPendiente > valorPrescrito) {
            Swal.fire('Error', 'La Cantidad Pendiente Debe Ser Igual o Menor a la Cantidad Prescrita.', 'warning');
            document.getElementById('cantidad_prescrita').value = '';
            document.getElementById('cantidad_pendiente').value = '';
        } 
    }
}

function calcularPendienteFinal(index, id) {
    const cantidadEntregadaElement = document.getElementById(`cantidadEntregada-${index}`);
    const cantidadPendienteFinalElement = document.getElementById(`cantidadPendienteFinal-${index}`);
    const cantidadPendienteFinalElementTD = document.getElementById(`cantidadPendienteFinalTD-${index}`);

    if (!cantidadEntregadaElement || !cantidadPendienteFinalElement) {
        console.error(`No se encontró uno de los elementos con id 'cantidadEntregada-${index}' o 'cantidadPendienteFinal-${index}'`);
        return;
    }

    if (cantidadEntregadaElement.value.trim() === '' || cantidadEntregadaElement.value === '0') {
        // Si no se ha ingresado nada en 'cantidadEntregada', mostrar el valor pendiente actual desde la base de datos
        fetch(`/api/obtener-cantidad-pendiente?idpendientes=${id}`)
            .then(response => response.json())
            .then(data => {
                const cantidadPendiente = Number(data.cantidadpendientefinal) || 0;
                cantidadPendienteFinalElement.textContent = cantidadPendiente;
            })
            .catch(error => {
                console.error('Error al obtener la cantidad pendiente final actualizada:', error);
            });
        return;
    }

    const cantidadEntregada = Number(cantidadEntregadaElement.value) || 0;

    // Realizar fetch para obtener el valor actualizado desde la base de datos
    fetch(`/api/obtener-cantidad-pendiente?idpendientes=${id}`)
        .then(response => response.json())
        .then(data => {
            const cantidadPendiente = Number(data.cantidadpendientefinal) || 0;  // Valor actualizado desde la base de datos

            // Validar si la cantidad entregada es mayor a la cantidad pendiente actualizada
            if (cantidadEntregada > cantidadPendiente) {
                alert('La cantidad entregada no puede ser mayor que la cantidad pendiente final.');
                // Limpiar el campo si no cumple la validación y evitar cálculos
                cantidadEntregadaElement.value = '';
                cantidadPendienteFinalElement.textContent = cantidadPendiente; // Restaurar el valor original
                cantidadPendienteFinalElementTD.style.backgroundColor = 'white'; // Restablecer el color a blanco
                return;
            }
            // Calcular el pendiente final
            const pendienteFinal = cantidadPendiente - cantidadEntregada;
            cantidadPendienteFinalElement.textContent = pendienteFinal >= 0 ? pendienteFinal : 0;
            if (cantidadPendienteFinalElement.textContent === '0') {
                cantidadPendienteFinalElementTD.style.backgroundColor = '#7edd8e';  
            } else {
                cantidadPendienteFinalElementTD.style.backgroundColor = 'white'; 
            }

        })
        .catch(error => {
            console.error('Error al obtener la cantidad pendiente final actualizada:', error);
        });
}


// Mostrar el modal de opciones
function mostrarOpciones() {
        document.getElementById('modalOpciones').style.display = 'block';
    }

    // Cerrar el modal de opciones
    function cerrarModal() {
        document.getElementById('modalOpciones').style.display = 'none';
        document.getElementById('modalCyS').style.display = 'none';
    }

    document.getElementById('generar-reporte-btn').addEventListener('click', () => {
            // Redirige a la ruta de descarga
            window.location.href = '/descargar-pendientes';
        });

    // Llamar al servidor para generar el reporte por fecha
    async function generarReporteHoy() {
        const fechaActual = `${year}-${month}-${day}`;
        cerrarModal()
        // Mostrar el letrero de carga con SweetAlert2
        const loader = Swal.fire({
            title: 'Generando reporte...',
            text: 'Se está procesando el archivo, por favor espera...',
            allowOutsideClick: false,
            didOpen: () => {
                Swal.showLoading();
            }
        });

        try {
            // Realizar la solicitud al servidor
            const response = await fetch(`/generar-reporte-hoy-pendientes?fechaActual=${fechaActual}`);

            if (response.ok) {
                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `reporte_pendientes_${fechaActual}.xlsx`; // El nombre del archivo
                document.body.appendChild(a);
                a.click();
                a.remove();
                window.URL.revokeObjectURL(url);

                // Mostrar mensaje de éxito
                Swal.fire('¡Éxito!', 'El reporte se ha generado correctamente.', 'success');
            } else {
                const errorData = await response.json();
                console.error('Error al generar el reporte:', errorData.error);
                Swal.fire('Error', errorData.error || 'Ocurrió un error al generar el reporte.', 'error');
            }
        } catch (error) {
            console.error('Error al realizar la solicitud:', error);
            Swal.fire('Error', 'Ocurrió un error inesperado al generar el reporte.', 'error');
        }
    }

    async function generarReporteCyS() {
        const eps = document.getElementById('CySeps').value;
        const fecha = document.querySelector('#modalCyS input[type="date"]').value;
        // El primer dia esta en: primerDiaMes
        if (!eps) {
            alert('Por favor selecciona una EPS');
            return;
        }

        if (!fecha) {
            alert('Por favor selecciona una fecha válida');
            return;
        }

        cerrarModal()
        // Mostrar el letrero de carga con SweetAlert2
        const loader = Swal.fire({
            title: 'Generando reporte...',
            text: 'Se está procesando el archivo, por favor espera...',
            allowOutsideClick: false,
            didOpen: () => {
                Swal.showLoading();
            }
        });

        try {
            const body = {
                fechaInicio: primerDiaMes,
                fechaFin: fecha,
                eps: eps
            };
            // Realizar la solicitud al servidor
            const response = await fetch('/generar-reporte-CyS-pendientes', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(body)
            });
            if (response.ok) {
                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `reporte_CyS.xlsx`; // El nombre del archivo
                document.body.appendChild(a);
                a.click();
                a.remove();
                window.URL.revokeObjectURL(url);

                // Mostrar mensaje de éxito
                Swal.fire('¡Éxito!', 'El reporte se ha generado correctamente.', 'success');
            } else {
                const errorData = await response.json();
                console.error('Error al generar el reporte:', errorData.error);
                Swal.fire('Error', errorData.error || 'Ocurrió un error al generar el reporte.', 'error');
            }
        } catch (error) {
            console.error('Error al realizar la solicitud:', error);
            Swal.fire('Error', 'Ocurrió un error inesperado al generar el reporte.', 'error');
        }
    }

    async function menuReporteCyS() {
        document.getElementById('modalOpciones').style = 'display: none;'
        document.getElementById('modalCyS').style = 'display: block'
        console.log("Acabamos menuReporteCyS")
    }

        document.getElementById('logoutButton').addEventListener('click', function() {
        // Hacer una solicitud al servidor para cerrar la sesión
        fetch('/logout', {
            method: 'POST',
            credentials: 'include'  // Incluir cookies en la solicitud
        }).then(response => {
            if (response.ok) {
                // Redirigir a la página de login después de cerrar sesión
                window.location.href = '/login.html';
            }
        }).catch(error => {
            console.error('Error al cerrar sesión:', error);
        });
    });


    // BUSCAR POR CEDULA Y DEVUELVE SEDE Y USUARIO
    document.getElementById('AU_identificacion_buscar').addEventListener('blur', function () {
        const cedula = document.getElementById('AU_identificacion_buscar').value.trim().toUpperCase();

        // Si el campo está vacío, no hacer nada
        if (cedula === '') {
            document.getElementById('AU_username1').value = '';
            document.getElementById('AU_sede1').value = '';
            return;
        }

        // Realizamos la solicitud al backend para obtener el usuario por cédula
        fetch(`/ObtenerUsuario/${cedula}`)
            .then(response => {
                if (!response.ok) {
                    throw new Error('Usuario no encontrado');
                }
                return response.json(); // Parsear la respuesta JSON
            })
            .then(data => {
                // Si el usuario existe, autocompletar los campos
                document.getElementById('AU_username1').value = data.username;
                document.getElementById('AU_sede1').value = data.sede;
            })
            .catch(error => {
                // Si ocurre un error, limpiar los campos y mostrar el mensaje
                document.getElementById('AU_username1').value = '';
                document.getElementById('AU_sede1').value = '';
                // Aquí puedes mostrar el mensaje de error si es necesario
                Swal.fire({
                    title: error.message,
                    text: "Por favor, ingrese una identificación válida",
                    icon: "error"
                    })
                document.getElementById('AU_identificacion_buscar').value = '';
            });
    });

    // También puedes agregar el evento 'keydown' para detectar la tecla 'Tab' y hacer la búsqueda
    document.getElementById('AU_identificacion_buscar').addEventListener('keydown', function (event) {
        // Si el usuario presiona Tab (keyCode 9), hacer la búsqueda
        if (event.key === "Tab") {
            const cedula = document.getElementById('AU_identificacion_buscar').value.trim().toUpperCase();

            // Si el campo está vacío, no hacer nada
            if (cedula === '') {
                document.getElementById('AU_username1').value = '';
                document.getElementById('AU_sede1').value = '';
                return;
            }

            // Realizamos la solicitud al backend para obtener el usuario por cédula
            fetch(`/ObtenerUsuario/${cedula}`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Usuario no encontrado');
                    }
                    return response.json(); // Parsear la respuesta JSON
                })
                .then(data => {
                    // Si el usuario existe, autocompletar los campos
                    document.getElementById('AU_username1').value = data.username;
                    document.getElementById('AU_sede1').value = data.sede;
                })
                .catch(error => {
                    // Si ocurre un error, limpiar los campos y mostrar el mensaje
                    document.getElementById('AU_username1').value = '';
                    document.getElementById('AU_sede1').value = '';
                    // Aquí puedes mostrar el mensaje de error si es necesario alert(error.message);
                });
        }
    });

    document.getElementById('actualizar-usuario-btn').addEventListener('click', function () {
        const cedula = document.getElementById('AU_identificacion_buscar').value.toUpperCase();
        const sede = document.getElementById('AU_sede2').value;

        // Verificar que la cédula y la nueva sede estén presentes
        if (!cedula || !sede) {
            Swal.fire({
                        title: "Por favor, completa todos los campos antes de actualizar.",
                        icon: "warning"
                        });
            return;
        }

        // Hacer la solicitud al backend para actualizar la sede
        fetch('/ActualizarUsuario', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ cedula, sede }), // Enviar solo cédula y sede
        })
            .then(response => response.json())
            .then(data => {
                if (data.message === 'Sede actualizada correctamente') {
                    Swal.fire({
                        title: "Sede actualizada correctamente",
                        icon: "success"
                        });
                    // Actualizar el campo de sede con la nueva sede
                    document.getElementById('AU_sede1').value = data.usuario.sede;
                    // Limpiar todos los campos
                    document.getElementById('AU_identificacion_buscar').value = '';
                    document.getElementById('AU_sede2').value = '';
                    document.getElementById('AU_sede1').value = '';
                    document.getElementById('AU_username1').value = '';
                } else {
                    Swal.fire('Error', 'Error al actualizar la sede', 'error');
                }
            })
            .catch((error) => {
                console.error('Error:', error);
                Swal.fire('Error', 'Hubo un problema con la solicitud para actualizar la sede', 'error');
            });
    });


    // ELIMINAR ESPACIOS EN PRINCIPAL

    document.addEventListener('DOMContentLoaded', function () {
    document.querySelectorAll('.identificacion').forEach(input => {
        input.addEventListener('blur', function () {
            this.value = this.value.trim(); // Elimina espacios al inicio automáticamente
        });
    });
});

// ELIMINAR ESPACIOS EN CREAR PACIENTES
document.addEventListener('DOMContentLoaded', function () {
    const inputIdentificacion = document.getElementById('Aidentificacion');

    if (inputIdentificacion) {
        inputIdentificacion.addEventListener('blur', function () {
            let valorLimpio = this.value.trim(); // Elimina espacios al inicio y al final
            if (this.value !== valorLimpio) {
                this.value = valorLimpio; // Actualiza el campo si había espacios
            }
        });
    } else {
        console.error("No se encontró el input con ID 'Aidentificacion'");
    }
});

    // Enviar a la bd pacientes

document.getElementById('agregar-paciente-btn-1').addEventListener('click', function() {
    document.getElementById("consulta_usuario").style.display = 'none';
    document.getElementById("id_formulario_principal").style.display = 'none';
    document.getElementById("result").style.display = 'none';
    document.getElementById("agregar_usuario").style.display = 'block';
    document.getElementById("texto_principal").innerText = 'Agregar Paciente';
    document.getElementById('pendientesResult').style.display = 'none';
    document.getElementById('text_agregar_usuario_SU').style.display = 'none';
});

    document.getElementById('usuarios-btn').addEventListener('click', function() {
    document.getElementById("consulta_usuario").style.display = 'none';
    document.getElementById("id_formulario_principal").style.display = 'none';
    document.getElementById("agregar_usuario").style.display = 'block';
    document.getElementById("texto_principal").innerText = 'Gestion Usuarios';
    document.getElementById('text_agregar_usuario_SU').style.display = 'none';
});

    document.getElementById('agregar-usuario-btn').addEventListener('click', function() {
            const nombre = document.getElementById('AU_nombre').value.toUpperCase();
            const identificacion = document.getElementById('AU_identificacion').value;
            const username = document.getElementById('AU_username').value.toUpperCase();
            const password = document.getElementById('AU_password').value;
            const sede = document.getElementById('AU_sede').value;
            const rol = document.getElementById('AU_rol').value;

            // Array para almacenar los mensajes de error
            let missingFields = [];

            // Verificar qué campos están vacíos
            if (!nombre) missingFields.push('Nombre');
            if (!identificacion) missingFields.push('Identificación');
            if (!username) missingFields.push('Username');
            if (!password) missingFields.push('Password');
            if (!sede) missingFields.push('Sede');
            if (!rol) missingFields.push('Rol');

            if (missingFields.length > 0) {
                    Swal.fire({
                        title: "Campos Obligatorios",
                        html: "Por favor completa los siguientes campos obligatorios: <br> - " + missingFields.join(' <br> - '),
                        icon: "warning",
                        confirmButtonText: "Aceptar"
                    });
                    return;
                }
            // Estructura de datos que se enviará al servidor
            const usuario = {
                nombrecompleto: nombre,
                cedula: identificacion,
                username: username,
                password: password,
                sede: sede,
                role: rol
            };
            // Realizar la solicitud al servidor
            fetch('/agregarUsuario', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(usuario),
            })
            .then((response) => {
                if (response.ok) {
                    Swal.fire({
                            title: "Usuario Agregado Correctamente",
                            icon: "success"
                        })
                } else {
                    Swal.fire({
                            title: "Error al Agregar Usuario",
                            icon: "Error"
                        })
                }
            })
            .catch((error) => {
                console.error('Error:', error);
                Swal.fire({
                            title: "Hubo un problema con la solicitud",
                            icon: "Error"
                        })
            });
            document.getElementById('AU_nombre').value = "" 
            document.getElementById('AU_identificacion').value = "" 
            document.getElementById('AU_username').value = ""
            document.getElementById('AU_password').value = ""
            document.getElementById('AU_sede').value = ""
            document.getElementById('AU_rol').value = ""
        });
    
    document.getElementById('AU_identificacion').addEventListener('blur', () => {
        const cedula = document.getElementById('AU_identificacion').value;

        // Hacer la solicitud al servidor para validar la cédula
        fetch('/validarCedula', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ cedula })
        })
            .then(response => response.json())
            .then(data => {
                if (data.message === 'La cédula ya está registrada') {
                    Swal.fire({
                    title: "La identificación ya está registrada.",
                    text: "Por favor, ingrese una cédula diferente.",
                    icon: "warning"
                    })
                    document.getElementById('AU_identificacion').value = "";
                } else if (data.message === 'La cédula está disponible') {
                    console.log('La cédula está disponible.');
                }
            })
            .catch(error => {
                console.error('Error:', error);
            });
    })
    
    document.getElementById('agregar-medicamento-btn').addEventListener('click', function() {
        
        const nombre = document.getElementById('AM_nombre').value.toUpperCase();
        const laboratorio = document.getElementById('AM_laboratorio').value.toUpperCase();
        const tipo = document.getElementById('AM_tipo_producto').value;
        const cobertura = document.getElementById('AM_cobertura').value;
        const cum = document.getElementById('AM_cum').value;

        // Array para almacenar los mensajes de error
        let missingFields = [];
            
     
            if (!nombre) missingFields.push('Nombre del Medicamento');
            if (!laboratorio) missingFields.push('Laboratorio');
            if (!AM_tipo_producto) missingFields.push('Tipo producto');
            if (!tipo) missingFields.push('Tipo del Producto');
            if (!cobertura) missingFields.push('Cobertura');
            if (!cum) missingFields.push('Cum');
            
            

            if (missingFields.length > 0) {
                    Swal.fire({
                        title: "Campos Obligatorios",
                        html: "Por favor completa los siguientes campos obligatorios: <br> - " + missingFields.join(' <br> - '),
                        icon: "warning",
                        confirmButtonText: "Aceptar"
                    });
                    return;
                }
        // Crear un objeto con los datos a enviar
        const medicamento = {
           
            nombre,
            laboratorio,
            tipo,
            cobertura,
            cum
        };
        // Realizar la solicitud POST al servidor
        fetch('/agregarMedicamentos', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',  // Definimos el tipo de contenido que estamos enviando
            },
            body: JSON.stringify(medicamento)  // Enviamos los datos como un JSON
        })
        .then((response) => {
            if (response.ok) {
                return response.json();  // Si la respuesta es exitosa, procesamos la respuesta
            } else {
                throw new Error('Error al agregar medicamento');
            }
        })
        .then((data) => {
            Swal.fire({
                        title: "Medicamento agregado correctamente",
                        icon: "success",
                        confirmButtonText: "Aceptar"
                    });
        })
        .catch((error) => {
            console.error('Error:', error);
            Swal.fire({
                        title: "Hubo un problema con la solicitud",
                        icon: "error",
                        confirmButtonText: "Aceptar"
                    });
        });
   
        document.getElementById('AM_nombre').value = ""
        document.getElementById('AM_laboratorio').value = ""
        document.getElementById('AM_tipo_producto').value = "";
        document.getElementById('AM_cum').value = ""
    });


      // Obtener el rol del usuario desde la URL
      const params = new URLSearchParams(window.location.search);
    const role = params.get('role');

    // Ocultar el botón de generar reporte si el usuario no es administrador
    if (role == 'user') {
        document.getElementById('generar-reporte').style.display = 'none';
        document.getElementById('usuarios-btn').style.display = 'none';
        document.getElementById('text_actualizar_usuario_SU').style.display = 'none';
        // document.getElementById('fecha_solicitud').setAttribute('readonly', true);
    }
    if (role == 'admin') {
        document.getElementById('usuarios-btn').style.display = 'none';
        document.getElementById('text_actualizar_usuario_SU').style.display = 'none';
    }

    if (role == 'superUser'){
        document.getElementById('agregar-paciente-btn-1').innerHTML = 'Agregar';
        document.getElementById('agregar-paciente-btn-1').addEventListener('click', function() {
            document.getElementById('agregar_usuario_SU').style.display = 'none';
            document.getElementById('actualizar_usuario_SU').style.display = 'none';
            // document.getElementById('agregar_medicamento_SU').style.display = 'block';
            document.getElementById('text_actualizar_usuario_SU').style.display = 'none';
            // document.getElementById('text_agregar_medicamento_SU').style.display = 'block';
        });
        document.getElementById('usuarios-btn').addEventListener('click', function() {
            document.getElementById('agregar_usuario_SU').style.display = 'block';
            document.getElementById('agregar_medicamento_SU').style.display = 'none';
            document.getElementById('text_agregar_medicamento_SU').style.display = 'none';
            document.getElementById('agregar_usuario').style.display = 'none';
            document.getElementById('pendientesResult').style.display = 'none';
            document.getElementById('result').style.display = 'none';
            document.getElementById('actualizar_usuario_SU').style.display ='block';
            document.getElementById('text_actualizar_usuario_SU').style.display = 'block';
            document.getElementById("texto_principal").innerText = 'Agregar Usuario';
        });
        document.getElementById('consulta-btn').addEventListener('click', function() {
            document.getElementById('agregar_usuario_SU').style.display = 'none';
            document.getElementById('agregar_medicamento_SU').style.display = 'none';
            document.getElementById('text_agregar_usuario_SU').style.display = 'none';
            document.getElementById('text_agregar_medicamento_SU').style.display = 'none';
            document.getElementById('actualizar_usuario_SU').style.display ='none';
            document.getElementById('text_actualizar_usuario_SU').style.display = 'none';
        });
    }

    	
    if (role == "superAdmin"){
        document.getElementById('agregar-paciente-btn-1').innerHTML = 'Agregar';
        document.getElementById('agregar-paciente-btn-1').addEventListener('click', function() {
            document.getElementById('agregar_usuario_SU').style.display = 'none';
            document.getElementById('actualizar_usuario_SU').style.display = 'none';
            document.getElementById('agregar_medicamento_SU').style.display = 'block';
            document.getElementById('text_actualizar_usuario_SU').style.display = 'none';
            document.getElementById('text_agregar_medicamento_SU').style.display = 'block';
        });
        document.getElementById('usuarios-btn').addEventListener('click', function() {
            document.getElementById('agregar_usuario_SU').style.display = 'block';
            document.getElementById('agregar_medicamento_SU').style.display = 'none';
            document.getElementById('text_agregar_medicamento_SU').style.display = 'none';
            document.getElementById('agregar_usuario').style.display = 'none';
            document.getElementById('pendientesResult').style.display = 'none';
            document.getElementById('result').style.display = 'none';
            document.getElementById('actualizar_usuario_SU').style.display ='block';
            document.getElementById('text_actualizar_usuario_SU').style.display = 'block';
            document.getElementById("texto_principal").innerText = 'Agregar Usuario';
        });
        document.getElementById('consulta-btn').addEventListener('click', function() {
            document.getElementById('agregar_usuario_SU').style.display = 'none';
            document.getElementById('agregar_medicamento_SU').style.display = 'none';
            document.getElementById('text_agregar_usuario_SU').style.display = 'none';
            document.getElementById('text_agregar_medicamento_SU').style.display = 'none';
            document.getElementById('actualizar_usuario_SU').style.display ='none';
            document.getElementById('text_actualizar_usuario_SU').style.display = 'none';
        });
    }

</script>